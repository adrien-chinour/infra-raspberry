version: '3.7'
services:
    database:
        image: jsurf/rpi-mariadb:latest
        command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
        restart: unless-stopped
        environment:
            MYSQL_RANDOM_ROOT_PASSWORD: 'yes'
            MYSQL_DATABASE: 'nextcloud'
            MYSQL_USER: 'nextcloud_user'
            MYSQL_PASSWORD: 'not a strong password'
        networks:
            - lan
        volumes:
            - db:/var/lib/mysql

    nextcloud:
        depends_on:
            - database
        image: nextcloud:18
        restart: unless-stopped
        environment:
            MYSQL_HOST: 'database'
            MYSQL_DATABASE: 'nextcloud'
            MYSQL_USER: 'nextcloud_user'
            MYSQL_PASSWORD: 'not a strong password'
            NEXTCLOUD_ADMIN_PASSWORD: 'not a strong password'
            NEXTCLOUD_ADMIN_USER: 'adrien'
            NEXTCLOUD_TRUSTED_DOMAINS: 'nextcloud.pi.chinour.fr'
        networks:
            - lan
            - traefik_network
        volumes:
            - html:/var/www/html
        labels:
            - "traefik.enable=true"
            - "traefik.docker.network=traefik_network"
            - "traefik.http.routers.nextcloud.entrypoints=web,websecure"
            - "traefik.http.routers.nextcloud.rule=Host(`nextcloud.pi.chinour.fr`)"
            - "traefik.http.routers.nextcloud.tls=true"
            - "traefik.http.routers.nextcloud.tls.certresolver=myresolver"
            - "traefik.http.routers.nextcloud.middlewares=nextcloud-dav"
            - "traefik.http.services.nextcloud.loadbalancer.server.port=80"
            - "traefik.http.middlewares.nextcloud-dav.replacepathregex.regex=^/.well-known/ca(l|rd)dav"
            - "traefik.http.middlewares.nextcloud-dav.replacepathregex.replacement=/remote.php/dav/"

volumes:
    db:
    html:

networks:
    traefik_network:
        external: true
    lan:
